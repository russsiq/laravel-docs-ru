# Laravel 8.x — Сброс пароля

- [Введение](#introduction)
    - [Подготовка модели](#model-preparation)
    - [Подготовка базы данных](#database-preparation)
- [Маршрутизация](#routing)
    - [Запрос ссылки для сброса пароля](#requesting-the-password-reset-link)
    - [Сброс пароля](#resetting-the-password)
- [Настройка](#password-customization)

<a name="introduction"></a>
## Введение

Большинство веб-приложений предоставляют пользователям возможность сбросить забытые пароли. Вместо того, чтобы заставлять вас заново реализовывать этот функционал самостоятельно для каждого создаваемого вами приложения, Laravel предоставляет удобные сервисы для отправки ссылок для сброса пароля и, собственно, безопасного сброса паролей.

> {tip} Хотите поскорее начать? Установите один из [стартовых комплектов](starter-kits.md) в новое приложение Laravel. Стартовые комплекты позаботятся о построении всей вашей системы аутентификации, включая сброс забытых паролей.

<a name="model-preparation"></a>
### Подготовка модели

Перед использованием функционала сброса пароля Laravel модель вашего приложения `App\Models\User` должна использовать трейт `Illuminate\Notifications\Notifiable`. Обычно этот трейт уже содержится по умолчанию в модели `App\Models\User`, создаваемая с новыми приложениями Laravel.

Затем убедитесь, что ваша модель `App\Models\User` реализует контракт `Illuminate\Contracts\Auth\CanResetPassword`. Модель `App\Models\User` Laravel, уже реализует этот интерфейс и использует трейт `Illuminate\Auth\Passwords\CanResetPassword`, включающий методы, необходимых для реализации интерфейса.

<a name="database-preparation"></a>
### Подготовка базы данных

Необходимо создать таблицу для сохранения токенов сброса пароля вашего приложения. Миграция для этой таблицы содержится по умолчанию в приложение Laravel, поэтому вам нужно только выполнить миграцию БД, чтобы создать эту таблицу:

    php artisan migrate

<a name="routing"></a>
## Маршрутизация

Чтобы правильно реализовать поддержку, позволяющую пользователям сбрасывать свои пароли, нам нужно будет определить несколько маршрутов. Во-первых, нам понадобится пара маршрутов для обработки, позволяющая пользователю запрашивать ссылку для сброса пароля через свой адрес электронной почты. Во-вторых, нам понадобится пара маршрутов для обработки фактического сброса пароля после того, как пользователь посетит ссылку для сброса пароля, отправленную ему по электронной почте, и заполнит форму сброса пароля.

<a name="requesting-the-password-reset-link"></a>
### Запрос ссылки для сброса пароля

<a name="the-password-reset-link-request-form"></a>
#### Форма запроса ссылки для сброса пароля

Сначала мы определим маршруты, которые необходимы для запроса ссылок для сброса пароля. Для начала мы определим маршрут, который возвращает шаблон с формой запроса ссылки для сброса пароля:

    Route::get('/forgot-password', function () {
        return view('auth.forgot-password');
    })->middleware('guest')->name('password.request');

Шаблон, возвращаемый этим маршрутом, должен иметь форму, содержащую поле `email`, которое позволит пользователю запрашивать ссылку для сброса пароля для указываемого адреса электронной почты.

<a name="password-reset-link-handling-the-form-submission"></a>
#### Обработка отправки формы

Затем мы определим маршрут, который обрабатывает запрос на отправку формы из шаблона «забытого пароль». Этот маршрут будет отвечать за проверку адреса электронной почты и отправку запроса на сброс пароля соответствующему пользователю:

    use Illuminate\Http\Request;
    use Illuminate\Support\Facades\Password;

    Route::post('/forgot-password', function (Request $request) {
        $request->validate(['email' => 'required|email']);

        $status = Password::sendResetLink(
            $request->only('email')
        );

        return $status === Password::RESET_LINK_SENT
                    ? back()->with(['status' => __($status)])
                    : back()->withErrors(['email' => __($status)]);
    })->middleware('guest')->name('password.email');

Прежде чем двигаться дальше, давайте рассмотрим этот маршрут более подробно. Сначала проверяется атрибут запроса `email`. Затем мы будем использовать встроенный в Laravel «брокер паролей» (через фасад `Password`), чтобы отправить пользователю ссылку для сброса пароля. Брокер паролей позаботится о получении пользователя по заданному полю (в данном случае по адресу электронной почты) и отправит пользователю ссылку для сброса пароля через встроенную [систему уведомлений](notifications.md) Laravel.

Метод `sendResetLink` возвращает ключ «status». Этот статус может быть переведен с помощью помощников [локализации](localization.md) Laravel, чтобы показать пользователю удобное сообщение о статусе его запроса. Перевод статуса сброса пароля определяется языковым файлом `resources/lang/{lang}/passwords.php` вашего приложения. Запись для каждого возможного значения ключа статуса находится в языковом файле `passwords`.

Вам может быть интересно: как Laravel знает о том, как получить запись пользователя из базы данных вашего приложения при вызове метода `sendResetLink` фасада `Password`? Брокер паролей Laravel использует «поставщиков пользователей» вашей системы аутентификации для получения записей из базы данных. Поставщик пользователей, используемый брокером паролей, настраивается в массиве `passwords` вашего файла конфигурации `config/auth.php`. Чтобы узнать больше о создании пользовательских поставщиков служб, обратитесь к [документации по аутентификации](authentication.md#adding-custom-user-providers).

> {tip} При выполнении сброса пароля самостоятельно, вы должны сами определять содержимое страницы и маршрутов. Если вам необходим каркас, включающий всю необходимую логику аутентификации и проверки, ознакомьтесь со [стартовыми комплектами приложений Laravel](starter-kits.md).

<a name="resetting-the-password"></a>
### Сброс пароля

<a name="the-password-reset-form"></a>
#### Форма сброса пароля

Затем мы определим маршруты, необходимые для фактического сброса пароля, когда пользователь щелкает ссылку для сброса пароля, отправленную ему по электронной почте, и предоставляет новый пароль. Во-первых, давайте определим маршрут, который будет отображать форму сброса пароля, после того как пользователь щелкает ссылку сброса пароля. Этот маршрут получит параметр `token`, который мы будем использовать позже для проверки запроса на сброс пароля:

    Route::get('/reset-password/{token}', function ($token) {
        return view('auth.reset-password', ['token' => $token]);
    })->middleware('guest')->name('password.reset');

Экран, возвращаемый этим маршрутом, должен отображать форму, содержащую поле `email`, поле `password`, поле `password_confirmation` и скрытое поле `token`, которое должно содержать значение секретного `$token`, полученного нашим маршрутом.

<a name="password-reset-handling-the-form-submission"></a>
#### Обработка отправки формы

Конечно, нам нужно определить маршрут для фактической обработки отправки формы сброса пароля. Этот маршрут будет отвечать за проверку входящего запроса и обновление пароля пользователя в базе данных:

    use Illuminate\Auth\Events\PasswordReset;
    use Illuminate\Http\Request;
    use Illuminate\Support\Facades\Hash;
    use Illuminate\Support\Facades\Password;
    use Illuminate\Support\Str;

    Route::post('/reset-password', function (Request $request) {
        $request->validate([
            'token' => 'required',
            'email' => 'required|email',
            'password' => 'required|min:8|confirmed',
        ]);

        $status = Password::reset(
            $request->only('email', 'password', 'password_confirmation', 'token'),
            function ($user, $password) use ($request) {
                $user->forceFill([
                    'password' => Hash::make($password)
                ])->save();

                $user->setRememberToken(Str::random(60));

                event(new PasswordReset($user));
            }
        );

        return $status == Password::PASSWORD_RESET
                    ? redirect()->route('login')->with('status', __($status))
                    : back()->withErrors(['email' => [__($status)]]);
    })->middleware('guest')->name('password.update');

Прежде чем двигаться дальше, давайте рассмотрим этот маршрут более подробно. Сначала проверяются атрибуты запроса `token`, `email`, и `password`. Далее мы будем использовать встроенный в Laravel «брокер паролей» (через фасад `Password`) для проверки учетных данных запроса сброса пароля.

Если токен, адрес электронной почты и пароль, переданные брокеру паролей, действительны, будет вызвано замыкание, переданное методу `reset`. В рамках этого замыкания, которое получает экземпляр пользователя и пароль в виде обычного текста из формы сброса пароля, мы можем обновить пароль пользователя в базе данных.

Метод `reset` возвращает ключ «status». Этот статус может быть переведен с помощью помощников [локализации](localization.md) Laravel, чтобы показать пользователю удобное сообщение о статусе его запроса.Перевод статуса сброса пароля определяется языковым файлом `resources/lang/{lang}/passwords.php` вашего приложения. Запись для каждого возможного значения ключа статуса находится в языковом файле `passwords`.

Прежде чем двигаться дальше, вам может быть интересно, как Laravel знает, как получить запись пользователя из базы данных вашего приложения при вызове метода `reset` фасада `Password`. Брокер паролей Laravel использует «поставщиков пользователей» вашей системы аутентификации для получения записей из базы данных. Поставщик пользователей, используемый брокером паролей, настраивается в массиве `passwords` вашего файла конфигурации `config/auth.php`. Чтобы узнать больше о создании пользовательских поставщиков служб, обратитесь к [документации по аутентификации](authentication.md#adding-custom-user-providers).

<a name="password-customization"></a>
## Настройка

<a name="reset-link-customization"></a>
#### Настройка ссылки для сброса

Вы можете изменить URL-адрес ссылки для сброса пароля, используя метод `createUrlUsing` класса уведомлений `ResetPassword`. Этот метод принимает замыкание, которое получает экземпляр ожидающего уведомление пользователя, а также токен ссылки для сброса пароля. Как правило, вы должны вызывать этот метод из метода `boot` вашего поставщика служб `App\Providers\AuthServiceProvider`:

    use Illuminate\Auth\Notifications\ResetPassword;

    /**
     * Регистрация любых служб аутентификации / авторизации.
     *
     * @return void
     */
    public function boot()
    {
        $this->registerPolicies();

        ResetPassword::createUrlUsing(function ($user, string $token) {
            return 'https://example.com/reset-password?token='.$token;
        });
    }

<a name="reset-email-customization"></a>
#### Настройка уведомлений о сбросе пароля

Вы можете легко изменить класс уведомления, используемый для отправки пользователю ссылки для сброса пароля. Для начала переопределите метод `sendPasswordResetNotification` в модели `App\Models\User`. В этом методе вы можете отправить уведомление, используя любой [класс уведомлений](notifications.md), созданный вами. Токен для сброса пароля – это первый аргумент, получаемый методом. Вы можете использовать этот `$token` для создания URL сброса пароля по вашему усмотрению и для дальнейшей отправки уведомления пользователю:

    use App\Notifications\ResetPasswordNotification;

    /**
     * Отправить пользователю уведомление о сбросе пароля.
     *
     * @param  string  $token
     * @return void
     */
    public function sendPasswordResetNotification($token)
    {
        $url = 'https://example.com/reset-password?token='.$token;

        $this->notify(new ResetPasswordNotification($url));
    }
